openapi: 3.1.0
info:
  title: LogLineOS API
  version: "1.0"
  description: |
    Ledger-only, append-only, multitenant backend for spans, automations, policies, prompts, and memory.
    All operations are append-only with cryptographic proofs (BLAKE3 + Ed25519).
    Authentication: Bearer tokens (API keys) issued via token_issuer kernel.
servers:
  - url: https://your-logline-api.example.com
    description: Production server
  - url: http://localhost:3000
    description: Local development server
paths:
  /api/spans:
    get:
      summary: List spans
      description: Retrieve spans from the ledger with optional filtering
      parameters:
        - in: query
          name: entity_type
          schema:
            type: string
          description: Filter by entity type (e.g., function, execution, memory)
        - in: query
          name: status
          schema:
            type: string
          description: Filter by status (e.g., active, complete, error)
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 1000
          description: Maximum number of spans to return
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Span"
    post:
      summary: Create span (append-only)
      description: Create a new span in the ledger. All spans are immutable and append-only.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Span"
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Span"
  /api/timeline:
    get:
      summary: Visible timeline
      description: Retrieve visible timeline filtered by RLS (Row-Level Security)
      parameters:
        - in: query
          name: visibility
          schema:
            type: string
            enum: [public, tenant, private]
            default: tenant
          description: Filter by visibility scope
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 1000
          description: Maximum number of items to return
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Span"
  /api/execute:
    post:
      summary: Schedule/trigger execution for a function span
      description: Schedule execution of a function kernel via the request worker
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                span_id:
                  type: string
                  format: uuid
                  description: ID of the function span to execute
              required:
                - span_id
      responses:
        "200":
          description: Accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  scheduled_for:
                    type: string
                    format: uuid
                  request_id:
                    type: string
                    format: uuid
  /api/metrics:
    get:
      summary: Execution metrics
      description: Retrieve execution metrics including counts and latency
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  counts:
                    type: array
                    items:
                      type: object
                      properties:
                        day:
                          type: string
                          format: date
                        status:
                          type: string
                        n:
                          type: integer
                  latency:
                    type: array
                    items:
                      type: object
                      properties:
                        day:
                          type: string
                          format: date
                        avg_ms:
                          type: integer
                        p95_ms:
                          type: number
  /api/timeline/stream:
    get:
      summary: Server-Sent Events stream of new spans
      description: Stream timeline updates in real-time via Server-Sent Events (SSE)
      responses:
        "200":
          description: text/event-stream
          content:
            text/event-stream:
              schema:
                type: string
  /api/memory:
    post:
      summary: Upsert memory
      description: |
        Store or update a memory span. Supports optional encryption for sensitive content.
        Session-aware: memories can be scoped to a session via X-LogLine-Session header.
      parameters:
        - in: header
          name: X-LogLine-Session
          schema:
            type: string
            format: uuid
          description: Session ID for session-scoped memories
        - in: header
          name: X-LogLine-Memory
          schema:
            type: string
            enum: [off, session-only, on]
            default: on
          description: Memory mode (off = no storage, session-only = session scope, on = full storage)
        - in: header
          name: X-LogLine-Sensitivity
          schema:
            type: string
            enum: [public, internal, secret, pii]
            default: internal
          description: Sensitivity level (determines encryption)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MemoryInput"
      responses:
        "200":
          description: Created or updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Memory"
  /api/memory/{id}:
    get:
      summary: Fetch one memory
      description: Retrieve a single memory span by ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Memory span ID
        - in: query
          name: tenant_id
          schema:
            type: string
          description: Tenant ID for RLS context
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Memory"
        "404":
          description: Memory not found
  /api/memory/search:
    get:
      summary: Search memories
      description: |
        Search memories with scope ranking (session → private → tenant → public).
        Supports text search and optional vector search.
      parameters:
        - in: query
          name: Q
          required: true
          schema:
            type: string
          description: Search query
        - in: query
          name: TOPK
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: Maximum number of results
        - in: query
          name: USE_VECTOR
          schema:
            type: boolean
            default: false
          description: Enable vector search (if available)
        - in: query
          name: tenant_id
          schema:
            type: string
          description: Tenant ID for RLS context
        - in: header
          name: X-LogLine-Session
          schema:
            type: string
            format: uuid
          description: Session ID for session-scoped search
        - in: header
          name: X-LogLine-Memory
          schema:
            type: string
            enum: [off, session-only, on]
            default: on
          description: Memory mode
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemorySearchResult"
components:
  schemas:
    Span:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique span identifier
        seq:
          type: integer
          minimum: 0
          description: Sequence number for versioning (append-only)
        entity_type:
          type: string
          description: Entity type (function, execution, memory, policy, etc.)
        who:
          type: string
          description: Actor who created the span
        did:
          type: string
          description: Action performed
        this:
          type: string
          description: Subject/target of the action
        at:
          type: string
          format: date-time
          description: Timestamp
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: Parent span ID
        related_to:
          type: array
          items:
            type: string
            format: uuid
          description: Related span IDs
        owner_id:
          type: string
          description: Owner identifier
        tenant_id:
          type: string
          description: Tenant identifier for multitenancy
        visibility:
          type: string
          enum: [private, tenant, public]
          description: Visibility scope
        status:
          type: string
          description: Status (active, complete, error, etc.)
        name:
          type: string
          description: Human-readable name
        description:
          type: string
          description: Description
        code:
          type: string
          description: Code content (for functions)
        language:
          type: string
          description: Programming language
        runtime:
          type: string
          description: Runtime environment
        input:
          type: object
          additionalProperties: true
          description: Input data
        output:
          type: object
          additionalProperties: true
          description: Output data
        error:
          type: object
          additionalProperties: true
          description: Error information
        duration_ms:
          type: integer
          description: Duration in milliseconds
        trace_id:
          type: string
          description: Trace identifier for distributed tracing
        prev_hash:
          type: string
          description: Previous span hash (chain integrity)
        curr_hash:
          type: string
          description: Current span hash (BLAKE3)
        signature:
          type: string
          description: Ed25519 signature
        public_key:
          type: string
          description: Public key for signature verification
        metadata:
          type: object
          additionalProperties: true
          description: Additional metadata
      required:
        - id
        - seq
        - entity_type
        - who
        - this
        - at
        - visibility
    MemoryInput:
      type: object
      properties:
        layer:
          type: string
          enum: [session, temporary, permanent, shared, local]
          description: Memory layer (lifecycle & retention)
        type:
          type: string
          enum: [note, fact, profile, preference, relationship, plan, action, other]
          description: Memory type
        session_id:
          type: string
          format: uuid
          description: Session ID for session-scoped memories
        content:
          type: object
          additionalProperties: true
          description: Memory content (JSON object)
        tags:
          type: array
          items:
            type: string
          description: Tags for categorization
        schema_id:
          type: string
          format: uuid
          description: Schema ID for validation
        sensitivity:
          type: string
          enum: [public, internal, secret, pii]
          default: internal
          description: Sensitivity level
        ttl_at:
          type: string
          format: date-time
          description: Time-to-live expiration
        owner_id:
          type: string
          description: Owner ID (defaults from auth context)
        tenant_id:
          type: string
          description: Tenant ID (defaults from auth context)
      required:
        - layer
        - type
        - content
    Memory:
      allOf:
        - $ref: "#/components/schemas/Span"
        - type: object
          properties:
            entity_type:
              type: string
              enum: [memory]
            layer:
              type: string
              enum: [session, temporary, permanent, shared, local]
              description: Memory layer (lifecycle & retention)
            type:
              type: string
              enum: [note, fact, profile, preference, relationship, plan, action, other]
              description: Memory type
            content:
              type: object
              additionalProperties: true
              description: Memory content (or {redacted: true} if encrypted)
            tags:
              type: array
              items:
                type: string
              description: Tags for categorization
            schema_id:
              type: string
              format: uuid
              nullable: true
              description: Schema ID for validation
            sensitivity:
              type: string
              enum: [public, internal, secret, pii]
              description: Sensitivity level
            ttl_at:
              type: string
              format: date-time
              nullable: true
              description: Time-to-live expiration
            session_id:
              type: string
              format: uuid
              nullable: true
              description: Session ID for session-scoped memories
            encrypted_content:
              type: string
              nullable: true
              description: Encrypted content (if sensitivity != public)
            encryption_iv:
              type: string
              nullable: true
              description: Encryption IV (12 bytes hex)
            encryption_tag:
              type: string
              nullable: true
              description: Encryption auth tag (16 bytes hex)
    MemorySearchResult:
      type: object
      properties:
        ok:
          type: boolean
        hits:
          type: array
          items:
            type: object
            properties:
              span_id:
                type: string
                format: uuid
              score:
                type: number
                description: Relevance score
              scope:
                type: string
                enum: [session, private, tenant, public]
                description: Scope where memory was found
              memory:
                $ref: "#/components/schemas/Memory"
        total:
          type: integer
          description: Total number of hits
        skipped:
          type: boolean
          description: Whether search was skipped (memory_mode=off)
        reason:
          type: string
          description: Reason if skipped
  /api/chat:
    post:
      summary: Execute prompt variant
      description: |
        Execute a prompt variant (chat assistant). Returns normalized schema with text, confidence, actions, citations.
        Uses prompt_runner_kernel internally.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                text:
                  type: string
                  description: User message text
                context:
                  type: string
                  description: Optional context to include
                variant_id:
                  type: string
                  format: uuid
                  description: Prompt variant ID (defaults to current bandit winner)
              required:
                - text
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PromptRunResponse"
        "400":
          description: Bad request
  /api/prompts/{id}:
    get:
      summary: Fetch prompt block or variant
      description: Retrieve a prompt block or variant by ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Prompt block or variant ID
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/PromptBlock"
                  - $ref: "#/components/schemas/PromptVariant"
        "404":
          description: Not found
  /api/prompts/search:
    get:
      summary: Search prompts by tags
      description: Search prompt blocks and variants by tags
      parameters:
        - in: query
          name: tags
          required: true
          schema:
            type: array
            items:
              type: string
          description: Tags to search for (match any)
        - in: query
          name: entity_type
          schema:
            type: string
            enum: [prompt_block, prompt_variant]
          description: Filter by entity type
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  oneOf:
                    - $ref: "#/components/schemas/PromptBlock"
                    - $ref: "#/components/schemas/PromptVariant"
  /api/prompts/variants/{family}:
    get:
      summary: List variants for family
      description: Get all variants for a prompt family (e.g., vv_chat_agent)
      parameters:
        - in: path
          name: family
          required: true
          schema:
            type: string
          description: Prompt family name
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PromptVariant"
  /api/prompts/build:
    post:
      summary: Trigger build for variant
      description: Build/compile a prompt variant into system prompt with compiled_hash
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                variant_id:
                  type: string
                  format: uuid
                  description: Prompt variant ID to build
              required:
                - variant_id
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PromptBuild"
  /api/prompts/eval/{eval_id}:
    post:
      summary: Run eval fixtures
      description: Execute evaluation fixtures for a prompt variant
      parameters:
        - in: path
          name: eval_id
          required: true
          schema:
            type: string
            format: uuid
          description: Prompt eval ID
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        fixture_type:
                          type: string
                        passed:
                          type: boolean
                        output:
                          type: object
components:
  schemas:
    PromptBlock:
      allOf:
        - $ref: "#/components/schemas/Span"
        - type: object
          properties:
            entity_type:
              type: string
              enum: [prompt_block]
            content:
              type: string
              description: Prompt text with {{variables}}
            metadata:
              type: object
              properties:
                priority:
                  type: integer
                  description: Priority (higher = more important, 120 = doctrine, 100 = product, 90 = app, 70 = task)
                vars:
                  type: object
                  additionalProperties: true
                  description: Variable definitions
                tags:
                  type: array
                  items:
                    type: string
                  description: Tags for categorization
    PromptVariant:
      allOf:
        - $ref: "#/components/schemas/Span"
        - type: object
          properties:
            entity_type:
              type: string
              enum: [prompt_variant]
            metadata:
              type: object
              properties:
                family:
                  type: string
                  description: Prompt family name (e.g., vv_chat_agent)
                block_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: IDs of prompt blocks to compose
                vars:
                  type: object
                  additionalProperties: true
                  description: Variant-specific variables (few_shots, tone, etc.)
    PromptBuild:
      allOf:
        - $ref: "#/components/schemas/Span"
        - type: object
          properties:
            entity_type:
              type: string
              enum: [prompt_build]
            input:
              type: object
              properties:
                variant_id:
                  type: string
                  format: uuid
            output:
              type: object
              properties:
                system_prompt:
                  type: string
                  description: Compiled system prompt text
                compiled_hash:
                  type: string
                  description: SHA256 hash of compiled prompt
            related_to:
              type: array
              items:
                type: string
                format: uuid
              description: Related variant_id
    PromptRun:
      allOf:
        - $ref: "#/components/schemas/Span"
        - type: object
          properties:
            entity_type:
              type: string
              enum: [prompt_run]
            input:
              type: object
              properties:
                variant_id:
                  type: string
                  format: uuid
                messages:
                  type: array
                  items:
                    type: object
                    properties:
                      role:
                        type: string
                        enum: [system, user, assistant]
                      content:
                        type: string
                compiled_hash:
                  type: string
            output:
              type: object
              properties:
                text:
                  type: string
                  description: Response text
                confidence:
                  type: number
                  minimum: 0
                  maximum: 1
                  description: Confidence score
                follow_up_question:
                  type: string
                  nullable: true
                actions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: [create_span, execute_function, query, none]
                      args:
                        type: object
                        additionalProperties: true
                citations:
                  type: array
                  items:
                    type: string
                    format: uuid
                telemetry:
                  type: object
                  properties:
                    tool_use_count:
                      type: integer
                      minimum: 0
                    model:
                      type: string
                    latency_ms:
                      type: integer
            related_to:
              type: array
              items:
                type: string
                format: uuid
              description: Related variant_id, build_id
    PromptRunResponse:
      type: object
      description: Normalized response from /api/chat
      properties:
        ok:
          type: boolean
        variant_id:
          type: string
          format: uuid
        compiled_hash:
          type: string
        text:
          type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
        follow_up_question:
          type: string
          nullable: true
        actions:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [create_span, execute_function, query, none]
              args:
                type: object
                additionalProperties: true
        citations:
          type: array
          items:
            type: string
            format: uuid
        telemetry:
          type: object
          properties:
            tool_use_count:
              type: integer
              minimum: 0
    ApiToken:
      type: object
      description: API token (hash stored in ledger, plaintext returned once)
      properties:
        id:
          type: string
          format: uuid
          description: Token span ID
        entity_type:
          type: string
          enum: [api_token]
        status:
          type: string
          enum: [active, revoked]
        metadata:
          type: object
          properties:
            app_id:
              type: string
              nullable: true
              description: Application ID that owns this token
            token_prefix:
              type: string
              description: Token prefix (e.g., tok_acme_)
            token_hash:
              type: string
              description: BLAKE3 hash of token (b3:hex)
            scopes:
              type: array
              items:
                type: string
              description: List of scopes (e.g., /api/spans:write)
            expires_at:
              type: string
              format: date-time
              description: Token expiration timestamp
        tenant_id:
          type: string
          description: Tenant ID
        owner_id:
          type: string
          description: Owner ID
    TokenIssueResponse:
      type: object
      description: Response from token_issuer kernel (plaintext token shown once)
      properties:
        ok:
          type: boolean
        token:
          type: string
          description: Plaintext token (shown once, not stored)
          example: tok_acme_AbCdEf123GhIjKlMnOpQrStUvWxYz
        tenant_id:
          type: string
        app_id:
          type: string
          nullable: true
        scopes:
          type: array
          items:
            type: string
        expires_at:
          type: string
          format: date-time
        token_id:
          type: string
          format: uuid
    ApiTokenRevoked:
      type: object
      description: Token revocation event
      properties:
        id:
          type: string
          format: uuid
        entity_type:
          type: string
          enum: [api_token_revoked]
        status:
          type: string
          enum: [revoked]
        related_to:
          type: array
          items:
            type: string
            format: uuid
          description: IDs of revoked tokens
        metadata:
          type: object
          properties:
            reason:
              type: string
              enum: [compromised, rotation, expired, manual]
              description: Reason for revocation
    TokenUse:
      type: object
      description: Token usage telemetry span
      properties:
        id:
          type: string
          format: uuid
        entity_type:
          type: string
          enum: [token_use]
        who:
          type: string
          enum: [edge:authorizer]
        status:
          type: string
          enum: [ok, denied]
        metadata:
          type: object
          properties:
            token_hash:
              type: string
              description: Hash of token used
            route:
              type: string
              description: API route accessed
            method:
              type: string
              description: HTTP method
            scopes_checked:
              type: array
              items:
                type: string
              description: Scopes that were checked
            trace_id:
              type: string
              description: Request trace ID
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: token
      description: |
        API token issued via token_issuer kernel.
        Format: tok_{tenant_id}_{random_base64url}
        Example: tok_acme_AbCdEf123GhIjKlMnOpQrStUvWxYz
