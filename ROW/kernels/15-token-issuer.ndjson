{"id":"00000000-0000-4000-8000-000000000015","seq":0,"entity_type":"function","who":"system:seed","did":"defined","this":"function","at":"2025-01-01T00:00:00Z","status":"active","name":"token_issuer_kernel","description":"Issues API tokens, stores only hash in ledger, returns plaintext token once","code":"globalThis.default = async function tokenIssuer(ctx) {\n  const { sql, insertSpan, now, crypto } = ctx;\n  const { tenant_id, app_id, scopes, ttl_hours = 720 } = ctx.input || {};\n  \n  if (!tenant_id || !scopes?.length) {\n    throw new Error('Missing required fields: tenant_id, scopes');\n  }\n  \n  const userId = ctx.env.APP_USER_ID || 'admin';\n  const tenantId = tenant_id;\n  \n  // Get pepper from environment (set via Secrets Manager)\n  const pepper = ctx.env.TOKEN_PEPPER || process.env.TOKEN_PEPPER;\n  if (!pepper) {\n    throw new Error('TOKEN_PEPPER not configured');\n  }\n  \n  // Generate token\n  const prefix = `tok_${tenant_id}_`;\n  const randomBytes = new Uint8Array(24);\n  crypto.getRandomValues(randomBytes);\n  const random = Buffer.from(randomBytes).toString('base64url');\n  const plaintext = prefix + random;\n  \n  // Hash = BLAKE3(plaintext + pepper)\n  const hashInput = new TextEncoder().encode(plaintext + pepper);\n  const hashBytes = crypto.blake3(hashInput);\n  const hashHex = crypto.hex(hashBytes);\n  const hashTag = `b3:${hashHex}`;\n  \n  // Calculate expiration\n  const expiresAt = new Date(Date.now() + (ttl_hours * 3600 * 1000)).toISOString();\n  \n  // Insert token span (hash only, no plaintext)\n  const tokenId = crypto.randomUUID();\n  const tokenSpan = {\n    id: tokenId,\n    seq: 0,\n    entity_type: 'api_token',\n    who: 'kernel:token_issuer',\n    did: 'issued',\n    this: 'security.token',\n    at: now(),\n    status: 'active',\n    owner_id: userId,\n    tenant_id: tenantId,\n    visibility: 'tenant',\n    metadata: {\n      app_id: app_id || null,\n      token_prefix: prefix,\n      token_hash: hashTag,\n      scopes: scopes,\n      expires_at: expiresAt\n    }\n  };\n  \n  await insertSpan(tokenSpan);\n  \n  // Return plaintext token ONLY ONCE (not stored in ledger)\n  return {\n    ok: true,\n    token: plaintext,\n    tenant_id: tenantId,\n    app_id: app_id || null,\n    scopes: scopes,\n    expires_at: expiresAt,\n    token_id: tokenId\n  };\n};","language":"javascript","runtime":"deno@1.x","owner_id":"system","tenant_id":"system","visibility":"public"}

