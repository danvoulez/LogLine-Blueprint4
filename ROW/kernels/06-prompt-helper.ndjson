{"id":"00000000-0000-4000-8000-000000000006","seq":1,"entity_type":"function","who":"system:seed","did":"defined","this":"function","at":"2025-01-01T00:00:00Z","status":"active","name":"prompt_fetch_kernel","description":"Fetches prompts from ledger by ID or tags and interpolates variables","code":"globalThis.default = async function fetchPrompt(ctx) {\n  const { client } = ctx;\n  const { prompt_id, tags, variables } = ctx.input;\n  \n  if (!prompt_id && !tags) {\n    throw new Error('Missing required field: prompt_id or tags');\n  }\n  \n  let query, params;\n  \n  if (prompt_id) {\n    // Fetch by ID\n    query = `\n      SELECT id, name, description, metadata\n      FROM ledger.visible_timeline\n      WHERE entity_type = 'prompt' AND id = $1\n      ORDER BY at DESC LIMIT 1\n    `;\n    params = [prompt_id];\n  } else {\n    // Fetch by tags (match any)\n    query = `\n      SELECT id, name, description, metadata\n      FROM ledger.visible_timeline\n      WHERE entity_type = 'prompt'\n        AND status = 'active'\n        AND metadata->'tags' ?| $1\n      ORDER BY at DESC\n      LIMIT 10\n    `;\n    params = [tags];\n  }\n  \n  const { rows: prompts } = await client.query(query, params);\n  \n  if (prompts.length === 0) {\n    throw new Error(`No prompts found for ${prompt_id ? 'id: ' + prompt_id : 'tags: ' + tags.join(', ')}`);\n  }\n  \n  console.log(`Found ${prompts.length} prompt(s)`);\n  \n  // Interpolate variables in template\n  function interpolate(template, vars) {\n    if (!vars) return template;\n    \n    let result = template;\n    for (const [key, value] of Object.entries(vars)) {\n      const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\n      result = result.replace(regex, String(value));\n    }\n    return result;\n  }\n  \n  // Process each prompt\n  const results = prompts.map(p => {\n    const meta = p.metadata || {};\n    const template = meta.template || '';\n    const interpolated = interpolate(template, variables);\n    \n    return {\n      id: p.id,\n      name: p.name,\n      description: p.description,\n      tags: meta.tags || [],\n      variables_expected: meta.variables || [],\n      variables_provided: variables ? Object.keys(variables) : [],\n      template_original: template,\n      template_interpolated: interpolated\n    };\n  });\n  \n  // Return first if fetched by ID, all if by tags\n  return prompt_id ? results[0] : results;\n};","language":"javascript","runtime":"deno@1.x","owner_id":"system","tenant_id":"system","visibility":"public"}
