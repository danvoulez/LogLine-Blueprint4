{"id":"c0c0c0c0-0000-4000-8000-bldp00000001","seq":1,"entity_type":"function","who":"system:seed","did":"defined","this":"function","at":"2025-01-01T00:00:00Z","status":"active","name":"build_prompt_kernel","description":"Builds prompt from variant blocks, computes compiled_hash, emits prompt_build span","code":"globalThis.default = async function buildPrompt(ctx) {\n  const { sql, insertSpan, now, crypto } = ctx;\n  const { variant_id, variables = {} } = ctx.input || {};\n  \n  if (!variant_id) {\n    throw new Error('Missing required field: variant_id');\n  }\n  \n  // 1. Fetch prompt_variant by ID\n  const variantResult = await sql(\n    'SELECT * FROM ledger.visible_timeline WHERE id = $1 AND entity_type = $2 ORDER BY \"when\" DESC, seq DESC LIMIT 1',\n    [variant_id, 'prompt_variant']\n  );\n  const variantRows = variantResult.rows;\n  \n  if (variantRows.length === 0) {\n    throw new Error(`Prompt variant not found: ${variant_id}`);\n  }\n  \n  const variant = variantRows[0];\n  const variantMeta = variant.metadata || {};\n  const blockIds = variantMeta.block_ids || [];\n  const variantVars = variantMeta.vars || {};\n  \n  // Merge variables: variant defaults + input overrides\n  const mergedVars = { ...variantVars, ...variables };\n  \n  // 2. Fetch prompt_blocks by block_ids\n  if (blockIds.length === 0) {\n    throw new Error('Variant has no block_ids');\n  }\n  \n  const blockResult = await sql(\n    'SELECT id, content, metadata, \"when\" FROM ledger.visible_timeline WHERE entity_type = $1 AND id = ANY($2) AND status = $3 ORDER BY \"when\" DESC',\n    ['prompt_block', blockIds, 'active']\n  );\n  const blockRows = blockResult.rows;\n  \n  if (blockRows.length === 0) {\n    throw new Error('No active prompt blocks found for variant');\n  }\n  \n  // 3. Sort blocks by priority (Doctrine > Product > App > Task)\n  // Priority is stored in metadata.priority (higher = more important)\n  blockRows.sort((a, b) => {\n    const priA = (a.metadata?.priority || 0);\n    const priB = (b.metadata?.priority || 0);\n    if (priA !== priB) return priB - priA; // Higher priority first\n    // If same priority, use timestamp (newer first)\n    return new Date(b.when || b.at) - new Date(a.when || a.at);\n  });\n  \n  // 4. Interpolate variables in block content\n  function interpolate(template, vars) {\n    if (!template || !vars) return template || '';\n    let result = String(template);\n    for (const [key, value] of Object.entries(vars)) {\n      const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\n      result = result.replace(regex, String(value));\n    }\n    return result;\n  }\n  \n  // Compose blocks (higher priority first, so later blocks override earlier)\n  const blockContents = blockRows.map(block => {\n    const content = block.content || '';\n    return interpolate(content, mergedVars);\n  });\n  \n  // Join with double newline\n  const systemPrompt = blockContents.join('\\n\\n');\n  \n  // 5. Compute BLAKE3 compiled_hash of final system_prompt\n  const promptBytes = new TextEncoder().encode(systemPrompt);\n  const hashBytes = crypto.blake3(promptBytes);\n  const compiledHash = crypto.hex(hashBytes);\n  \n  // 6. Emit prompt_build span\n  const buildId = crypto.randomUUID();\n  const buildSpan = {\n    id: buildId,\n    seq: 0,\n    entity_type: 'prompt_build',\n    who: 'edge:build_prompt',\n    did: 'built',\n    this: 'prompt.build',\n    at: now(),\n    status: 'complete',\n    owner_id: variant.owner_id,\n    tenant_id: variant.tenant_id,\n    visibility: variant.visibility || 'private',\n    related_to: [variant_id],\n    output: {\n      system_prompt: systemPrompt,\n      compiled_hash: compiledHash,\n      variant_id: variant_id,\n      block_count: blockRows.length,\n      variables_used: Object.keys(mergedVars)\n    },\n    metadata: {\n      block_ids: blockIds,\n      variables: mergedVars\n    }\n  };\n  \n  await insertSpan(buildSpan);\n  \n  return {\n    ok: true,\n    build_id: buildId,\n    system_prompt: systemPrompt,\n    compiled_hash: compiledHash,\n    block_count: blockRows.length\n  };\n};","language":"javascript","runtime":"deno@1.x","owner_id":"system","tenant_id":"system","visibility":"public"}

