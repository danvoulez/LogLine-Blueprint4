{"id":"00000000-0000-4000-8000-000000000008","seq":1,"entity_type":"function","who":"system:seed","did":"defined","this":"function","at":"2025-01-01T00:00:00Z","status":"active","name":"app_enrollment_kernel","description":"Handles app enrollment, device registration, and key management","code":"globalThis.default = async function appEnrollment(ctx) {\n  const { sql, insertSpan, now, crypto } = ctx;\n  const { action, app_name, app_version, device_fingerprint, pubkey, tenant_id, app_id } = ctx.input || {};\n  \n  if (!action) {\n    throw new Error('Missing required field: action (enroll|register_device|get_manifest)');\n  }\n  \n  // ACTION: ENROLL - Register new app/device\n  if (action === 'enroll') {\n    if (!app_name || !pubkey || !device_fingerprint) {\n      throw new Error('Missing required fields: app_name, pubkey, device_fingerprint');\n    }\n    \n    const appId = crypto.randomUUID();\n    const deviceId = crypto.randomUUID();\n    const userId = ctx.env.APP_USER_ID || 'system';\n    const tenantIdResolved = tenant_id || ctx.env.APP_TENANT_ID || 'system';\n    \n    // Create app registration span\n    const appSpan = {\n      id: appId,\n      seq: 0,\n      entity_type: 'app_registration',\n      who: 'edge:enrollment',\n      did: 'enrolled',\n      this: 'app',\n      at: now(),\n      status: 'active',\n      owner_id: userId,\n      tenant_id: tenantIdResolved,\n      visibility: 'private',\n      metadata: {\n        app_name,\n        app_version: app_version || '1.0.0',\n        device_fingerprint,\n        pubkey,\n        device_id: deviceId,\n        enrolled_at: Date.now()\n      }\n    };\n    \n    await insertSpan(appSpan);\n    \n    // Create device registration span\n    const deviceSpan = {\n      id: deviceId,\n      seq: 0,\n      entity_type: 'device',\n      who: 'edge:enrollment',\n      did: 'registered',\n      this: 'device',\n      at: now(),\n      status: 'active',\n      owner_id: userId,\n      tenant_id: tenantIdResolved,\n      visibility: 'private',\n      metadata: {\n        fingerprint: device_fingerprint,\n        pubkey,\n        app_id: appId,\n        app_name,\n        registered_at: Date.now()\n      }\n    };\n    \n    await insertSpan(deviceSpan);\n    \n    // Fetch latest manifest for this tenant\n    const { rows: manifestRows } = await sql(\n      `SELECT id, metadata FROM ledger.visible_timeline\n       WHERE entity_type = 'manifest'\n       ORDER BY at DESC, seq DESC\n       LIMIT 1`,\n      []\n    );\n    \n    const manifest = manifestRows[0] || { metadata: {} };\n    \n    return {\n      ok: true,\n      status: 'enrolled',\n      app_id: appId,\n      device_id: deviceId,\n      tenant_id: tenantIdResolved,\n      owner_id: userId,\n      manifest: manifest.metadata,\n      message: 'App enrolled successfully. Store app_id and device_id securely.'\n    };\n  }\n  \n  // ACTION: REGISTER_DEVICE - Register additional device for existing app\n  if (action === 'register_device') {\n    if (!app_id || !device_fingerprint || !pubkey) {\n      throw new Error('Missing required fields: app_id, device_fingerprint, pubkey');\n    }\n    \n    // Verify app exists\n    const { rows: appRows } = await sql(\n      `SELECT id, metadata FROM ledger.visible_timeline\n       WHERE id = $1 AND entity_type = 'app_registration'\n       ORDER BY at DESC, seq DESC\n       LIMIT 1`,\n      [app_id]\n    );\n    \n    if (appRows.length === 0) {\n      throw new Error('App not found. Please enroll first.');\n    }\n    \n    const app = appRows[0];\n    const deviceId = crypto.randomUUID();\n    \n    const deviceSpan = {\n      id: deviceId,\n      seq: 0,\n      entity_type: 'device',\n      who: 'edge:enrollment',\n      did: 'registered',\n      this: 'device',\n      at: now(),\n      status: 'active',\n      owner_id: app.owner_id,\n      tenant_id: app.tenant_id,\n      visibility: 'private',\n      metadata: {\n        fingerprint: device_fingerprint,\n        pubkey,\n        app_id: app_id,\n        app_name: app.metadata.app_name,\n        registered_at: Date.now()\n      }\n    };\n    \n    await insertSpan(deviceSpan);\n    \n    return {\n      ok: true,\n      status: 'device_registered',\n      device_id: deviceId,\n      app_id: app_id,\n      message: 'Device registered successfully'\n    };\n  }\n  \n  // ACTION: GET_MANIFEST - Get current manifest for app\n  if (action === 'get_manifest') {\n    if (!app_id) {\n      throw new Error('Missing required field: app_id');\n    }\n    \n    // Verify app exists and get tenant context\n    const { rows: appRows } = await sql(\n      `SELECT tenant_id FROM ledger.visible_timeline\n       WHERE id = $1 AND entity_type = 'app_registration'\n       ORDER BY at DESC, seq DESC\n       LIMIT 1`,\n      [app_id]\n    );\n    \n    if (appRows.length === 0) {\n      throw new Error('App not found');\n    }\n    \n    const appTenant = appRows[0].tenant_id;\n    \n    // Get latest manifest\n    const { rows: manifestRows } = await sql(\n      `SELECT id, name, metadata, at FROM ledger.visible_timeline\n       WHERE entity_type = 'manifest'\n         AND (tenant_id = $1 OR visibility = 'public')\n       ORDER BY at DESC, seq DESC\n       LIMIT 1`,\n      [appTenant]\n    );\n    \n    if (manifestRows.length === 0) {\n      throw new Error('No manifest available');\n    }\n    \n    const manifest = manifestRows[0];\n    \n    return {\n      ok: true,\n      status: 'manifest_fetched',\n      manifest: {\n        id: manifest.id,\n        name: manifest.name,\n        updated_at: manifest.at,\n        policies: manifest.metadata\n      }\n    };\n  }\n  \n  throw new Error(`Unknown action: ${action}. Use enroll|register_device|get_manifest`);\n};","language":"javascript","runtime":"deno@1.x","owner_id":"system","tenant_id":"system","visibility":"public"}
