{"id":"00000000-0000-4000-8000-000000000007","seq":3,"entity_type":"function","who":"system:seed","did":"defined","this":"function","at":"2025-01-01T00:00:00Z","status":"active","name":"memory_store_kernel","description":"Stores and retrieves memory spans (ledger-only, Blueprint4-compliant)","code":"globalThis.default = async function memoryStore(ctx) {\n  const { sql, insertSpan, now, crypto } = ctx;\n  const { action, memory_type, content, tags, search_query, limit = 10, session_id, sensitivity } = ctx.input || {};\n  \n  if (!action) {\n    throw new Error('Missing required field: action (store|search|list)');\n  }\n  \n  // ACTION: STORE\n  if (action === 'store') {\n    if (!content) {\n      throw new Error('Missing required field: content');\n    }\n    \n    const memoryId = crypto.randomUUID();\n    const memorySpan = {\n      id: memoryId,\n      seq: 0,\n      entity_type: 'memory',\n      who: ctx.env.APP_USER_ID || 'system',\n      did: 'stored',\n      this: 'memory',\n      at: now(),\n      status: 'active',\n      owner_id: ctx.env.APP_USER_ID || 'system',\n      tenant_id: ctx.env.APP_TENANT_ID || 'system',\n      visibility: 'private',\n      metadata: {\n        layer: memory_type || 'local',\n        type: 'note',\n        content,\n        tags: tags || [],\n        sensitivity: sensitivity || 'internal',\n        session_id: session_id || null,\n        stored_at: Date.now()\n      }\n    };\n    \n    await insertSpan(memorySpan);\n    \n    return {\n      ok: true,\n      status: 'stored',\n      memory_id: memoryId,\n      memory_type: memory_type || 'local',\n      content_length: content.length,\n      tags: tags || []\n    };\n  }\n  \n  // ACTION: SEARCH\n  if (action === 'search') {\n    if (!search_query) {\n      throw new Error('Missing required field: search_query');\n    }\n    \n    const searchPattern = '%' + search_query + '%';\n    const { rows: memories } = await sql(\n      `SELECT id, at, metadata\n       FROM ledger.visible_timeline\n       WHERE entity_type = 'memory'\n         AND status = 'active'\n         AND (metadata->>'content' ILIKE $1 OR EXISTS (\n           SELECT 1 FROM jsonb_array_elements_text(metadata->'tags') tag\n           WHERE tag ILIKE $1\n         ))\n       ORDER BY at DESC\n       LIMIT $2`,\n      [searchPattern, limit]\n    );\n    \n    return {\n      ok: true,\n      status: 'found',\n      query: search_query,\n      count: memories.length,\n      memories: memories.map(m => ({\n        id: m.id,\n        stored_at: m.at,\n        content: m.metadata.content,\n        tags: m.metadata.tags || [],\n        memory_type: m.metadata.layer\n      }))\n    };\n  }\n  \n  // ACTION: LIST\n  if (action === 'list') {\n    const { rows: memories } = await sql(\n      `SELECT id, at, metadata\n       FROM ledger.visible_timeline\n       WHERE entity_type = 'memory'\n         AND status = 'active'\n       ORDER BY at DESC\n       LIMIT $1`,\n      [limit]\n    );\n    \n    return {\n      ok: true,\n      status: 'listed',\n      count: memories.length,\n      memories: memories.map(m => ({\n        id: m.id,\n        stored_at: m.at,\n        content_preview: (m.metadata.content || '').substring(0, 100) + '...',\n        tags: m.metadata.tags || [],\n        memory_type: m.metadata.layer\n      }))\n    };\n  }\n  \n  throw new Error(`Unknown action: ${action}. Use store|search|list`);\n};","language":"javascript","runtime":"deno@1.x","owner_id":"system","tenant_id":"system","visibility":"public"}
